(function(){var $$=this,$=this.IntelliFactory.Runtime,a,b,c,d,e,f,g,h,i,j,k,l,m,n;$.Define($$,{WebSharper:{Owin:{WebSocket:{Client:{ConnectTo:function(o,p){var q,r,u,G;q=new a(o.URI);r=function(s){return b.Start(e.processResponse(q,p.PostAndAsyncReply(function(t){return[s,t];},{$:0})),{$:0});};u=g.Start(function(v){var w;w=function(x){return b.Delay(function(){var z;z=v.Receive({$:0});return b.Bind(z,function(A){var B;if(A.$==1){return w({State:{$:1},Queue:x.Queue});}else{if(A.$==2){B=A.$0;if(x.State.$==1){x.Queue.Add(B);return w(x);}else{return b.Bind(e.processResponse(q,b.Return(B)),function(){return w(x);});}}else{return b.Combine(b.For(x.Queue,function(D){return b.Bind(e.processResponse(q,b.Return(D)),function(){return b.Return(null);});}),b.Delay(function(){x.Queue.Clear();return w({State:{$:0},Queue:x.Queue});}));}}});});};return w({State:{$:1},Queue:j.New2()});},{$:0});G=g.Start(function(H){var I;I=function(){return b.Delay(function(){return b.Bind(H.Receive({$:0}),function(L){u.mailbox.AddLast({$:2,$0:L});u.resume();return I(null);});});};return I(null);},{$:0});q.onopen=function(){u.mailbox.AddLast({$:0});u.resume();return r({$:2,$0:G});};q.onclose=function(){u.mailbox.AddLast({$:1});u.resume();return r({$:3});};q.onmessage=function(O){return r({$:0,$0:k.Activate(l.parse(O.data))});};q.onerror=function(){return r({$:1,$0:m.New1("error")});};return G;},processResponse:function(Q,R){return b.Delay(function(){return b.Combine(b.While(function(){return!n.Equals(Q.readyState,1);},b.Delay(function(){return b.Bind(b.Sleep(10),function(){return b.Return(null);});})),b.Delay(function(){return b.Bind(R,function(X){if(X.$==1){Q.close();return b.Return(null);}else{Q.send(l.stringify(X.$0));return b.Return(null);}});}));});}}}}}});$.OnInit(function(){a=$.Safe($$.WebSocket);b=$.Safe($$.WebSharper.Concurrency);c=$.Safe($$.WebSharper.Owin);d=$.Safe(c.WebSocket);e=$.Safe(d.Client);f=$.Safe($$.WebSharper.Control);g=$.Safe(f.MailboxProcessor);h=$.Safe($$.WebSharper.Collections);i=$.Safe(h.ResizeArray);j=$.Safe(i.ResizeArrayProxy);k=$.Safe($$.WebSharper.Json);l=$.Safe($$.JSON);m=$.Safe($$.WebSharper.Exception);return n=$.Safe($$.WebSharper.Unchecked);});$.OnLoad(function(){return;});}());
